<!DOCTYPE html>
<html class="dark" lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Running Pacer - Dashboard</title>
    <meta name="description" content="AI-Powered Running Analytics Dashboard" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
        href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&family=Noto+Sans:wght@100..900&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#FFB300",
                        "primary-hover": "#FFCA28",
                        "background-light": "#f1f5f9",
                        "background-dark": "#0B1120",
                        "surface-dark": "#151e32",
                        "surface-highlight": "#1e2942",
                        "text-secondary": "#94a3b8",
                        "border-dark": "#2a3655"
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"],
                        "body": ["Noto Sans", "sans-serif"]
                    },
                    boxShadow: {
                        'glow': '0 0 20px rgba(255, 179, 0, 0.25)',
                        'subtle': '0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1)'
                    }
                },
            },
        }
    </script>
    <style>
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0B1120;
        }

        ::-webkit-scrollbar-thumb {
            background: #1e2942;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #FFB300;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .material-symbols-outlined.fill {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-white font-display overflow-hidden selection:bg-primary selection:text-background-dark">
    <div class="flex h-screen w-full">
        <!-- Sidebar -->
        <aside class="hidden md:flex w-64 flex-col bg-background-dark border-r border-border-dark h-full shrink-0 z-20">
            <div class="flex flex-col h-full p-4 justify-between">
                <div class="flex flex-col gap-10">
                    <!-- Logo -->
                    <div class="flex gap-3 items-center px-2 py-2">
                        <div
                            class="flex items-center justify-center size-10 bg-primary rounded-lg -skew-x-12 shadow-glow">
                            <span class="material-symbols-outlined text-background-dark font-bold text-2xl"
                                style="transform: skewX(12deg)">bolt</span>
                        </div>
                        <div class="flex flex-col justify-center">
                            <h1 class="text-white text-xl font-black italic tracking-tight uppercase leading-none">
                                Running<span class="text-primary">Pacer</span></h1>
                            <p class="text-text-secondary text-[10px] font-medium tracking-widest uppercase mt-1">Elite
                                Performance</p>
                        </div>
                    </div>

                    <!-- Navigation -->
                    <nav class="flex flex-col gap-2">
                        <a class="flex items-center gap-3 px-4 py-3 rounded-lg bg-surface-highlight border-l-4 border-primary shadow-subtle group transition-all"
                            href="/">
                            <span class="material-symbols-outlined text-primary">dashboard</span>
                            <p class="text-white text-sm font-bold leading-normal">Dashboard</p>
                        </a>
                        <a class="flex items-center gap-3 px-4 py-3 rounded-lg border-l-4 border-transparent hover:bg-surface-highlight/50 group transition-all"
                            href="/activities">
                            <span
                                class="material-symbols-outlined text-text-secondary group-hover:text-white transition-colors">directions_run</span>
                            <p
                                class="text-text-secondary group-hover:text-white text-sm font-medium leading-normal transition-colors">
                                Activities</p>
                        </a>
                        <!-- Disabled Menu Items -->
                        <div class="flex items-center gap-3 px-4 py-3 rounded-lg border-l-4 border-transparent opacity-40 cursor-not-allowed"
                            title="준비 중">
                            <span class="material-symbols-outlined text-text-secondary">bar_chart</span>
                            <p class="text-text-secondary text-sm font-medium leading-normal">Analytics</p>
                            <span
                                class="ml-auto text-[10px] bg-surface-highlight px-2 py-0.5 rounded text-text-secondary">Soon</span>
                        </div>
                        <div class="flex items-center gap-3 px-4 py-3 rounded-lg border-l-4 border-transparent opacity-40 cursor-not-allowed"
                            title="준비 중">
                            <span class="material-symbols-outlined text-text-secondary">calendar_month</span>
                            <p class="text-text-secondary text-sm font-medium leading-normal">Training Plan</p>
                            <span
                                class="ml-auto text-[10px] bg-surface-highlight px-2 py-0.5 rounded text-text-secondary">Soon</span>
                        </div>
                        <div class="flex items-center gap-3 px-4 py-3 rounded-lg border-l-4 border-transparent opacity-40 cursor-not-allowed"
                            title="준비 중">
                            <span class="material-symbols-outlined text-text-secondary">settings</span>
                            <p class="text-text-secondary text-sm font-medium leading-normal">Settings</p>
                            <span
                                class="ml-auto text-[10px] bg-surface-highlight px-2 py-0.5 rounded text-text-secondary">Soon</span>
                        </div>
                    </nav>
                </div>

                <!-- User Profile & Logout -->
                <div class="px-2">
                    <div class="flex items-center gap-3 mb-6 p-3 bg-surface-dark rounded-xl border border-white/5">
                        <div class="size-10 rounded-full bg-primary/20 flex items-center justify-center">
                            <span class="material-symbols-outlined text-primary">person</span>
                        </div>
                        <div class="overflow-hidden">
                            <p class="text-white text-sm font-bold truncate" th:text="${name}">User</p>
                            <p class="text-text-secondary text-xs truncate" th:text="${email}">user@example.com</p>
                        </div>
                    </div>
                    <form th:action="@{/logout}" method="post">
                        <button type="submit"
                            class="flex w-full items-center justify-center gap-2 rounded-lg py-2.5 bg-surface-highlight/30 text-text-secondary text-sm font-bold hover:bg-surface-highlight hover:text-white transition-colors">
                            <span class="material-symbols-outlined text-[20px]">logout</span>
                            <span>Sign Out</span>
                        </button>
                    </form>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div
            class="flex-1 flex flex-col h-full overflow-hidden relative bg-gradient-to-br from-background-dark to-[#050914]">
            <!-- Header -->
            <header
                class="flex items-center justify-between whitespace-nowrap border-b border-solid border-border-dark px-6 py-5 bg-background-dark/80 backdrop-blur-md z-10 sticky top-0">
                <div class="flex items-center gap-4 text-white">
                    <div class="md:hidden p-2 rounded-lg hover:bg-surface-highlight cursor-pointer text-text-secondary">
                        <span class="material-symbols-outlined">menu</span>
                    </div>
                    <h2 class="text-white text-xl font-bold leading-tight tracking-tight">Dashboard Overview</h2>
                </div>
                <div class="flex items-center justify-end gap-4 md:gap-6">
                    <!-- Strava Status -->
                    <div th:if="${isStravaLinked}"
                        class="hidden sm:flex items-center gap-2 px-3 py-1.5 rounded-full bg-green-500/10 border border-green-500/20">
                        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                        <span class="text-green-400 text-xs font-bold">Strava Linked</span>
                    </div>
                    <div th:unless="${isStravaLinked}"
                        class="hidden sm:flex items-center gap-2 px-3 py-1.5 rounded-full bg-red-500/10 border border-red-500/20">
                        <div class="w-2 h-2 rounded-full bg-red-500"></div>
                        <span class="text-red-400 text-xs font-bold">Strava Unlinked</span>
                    </div>

                    <div class="hidden sm:flex gap-3">
                        <button th:if="${isStravaLinked}" onclick="openSyncModal()"
                            class="flex cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg h-10 px-5 bg-primary hover:bg-primary-hover transition-colors text-background-dark text-sm font-bold leading-normal tracking-wide shadow-glow">
                            <span class="material-symbols-outlined text-[20px]">sync</span>
                            <span>Sync</span>
                        </button>
                        <button th:unless="${isStravaLinked}" onclick="connectStrava()"
                            class="flex cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg h-10 px-5 bg-[#FC4C02] hover:bg-[#E34402] transition-colors text-white text-sm font-bold leading-normal tracking-wide">
                            <span class="material-symbols-outlined text-[20px]">link</span>
                            <span>Connect Strava</span>
                        </button>
                        <button
                            class="flex size-10 cursor-pointer items-center justify-center overflow-hidden rounded-lg bg-surface-highlight text-text-secondary hover:text-white hover:bg-surface-highlight/80 transition-colors border border-white/5 opacity-50 cursor-not-allowed"
                            disabled title="준비 중">
                            <span class="material-symbols-outlined text-[22px]">notifications</span>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Main Content Area -->
            <main class="flex-1 overflow-y-auto p-4 md:p-8 flex justify-center">
                <div class="max-w-[1280px] w-full flex flex-col gap-6 pb-8">
                    <!-- Stats Cards -->
                    <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div
                            class="flex flex-col gap-2 rounded-xl p-6 bg-surface-dark border border-white/5 shadow-subtle hover:border-primary/30 transition-colors group">
                            <div class="flex justify-between items-start">
                                <p
                                    class="text-text-secondary text-xs font-bold uppercase tracking-widest group-hover:text-primary transition-colors">
                                    Weekly Distance</p>
                                <div class="p-2 bg-background-dark rounded-lg text-primary">
                                    <span class="material-symbols-outlined text-[20px]">straighten</span>
                                </div>
                            </div>
                            <div class="mt-2">
                                <p class="text-white text-3xl font-bold leading-tight tracking-tight"><span
                                        id="week-dist">0.0</span> <span
                                        class="text-lg text-text-secondary font-medium">km</span></p>
                                <p id="week-count" class="text-xs text-text-secondary mt-2">0 runs this week</p>
                            </div>
                        </div>
                        <div
                            class="flex flex-col gap-2 rounded-xl p-6 bg-surface-dark border border-white/5 shadow-subtle hover:border-primary/30 transition-colors group">
                            <div class="flex justify-between items-start">
                                <p
                                    class="text-text-secondary text-xs font-bold uppercase tracking-widest group-hover:text-primary transition-colors">
                                    4-Week Trend</p>
                                <div class="p-2 bg-background-dark rounded-lg text-primary">
                                    <span class="material-symbols-outlined text-[20px]">trending_up</span>
                                </div>
                            </div>
                            <div class="mt-2">
                                <p id="trend-val" class="text-white text-3xl font-bold leading-tight tracking-tight">-
                                </p>
                                <p id="trend-desc" class="text-xs text-text-secondary mt-2">Calculating...</p>
                            </div>
                            <div class="h-10 mt-2"><canvas id="trendChart"></canvas></div>
                        </div>
                        <div
                            class="flex flex-col gap-2 rounded-xl p-6 bg-surface-dark border border-white/5 shadow-subtle hover:border-primary/30 transition-colors group">
                            <div class="flex justify-between items-start">
                                <p
                                    class="text-text-secondary text-xs font-bold uppercase tracking-widest group-hover:text-primary transition-colors">
                                    Condition Risk</p>
                                <div class="p-2 bg-background-dark rounded-lg text-primary">
                                    <span class="material-symbols-outlined text-[20px]">health_and_safety</span>
                                </div>
                            </div>
                            <div class="mt-2">
                                <p id="risk-score" class="text-white text-3xl font-bold leading-tight tracking-tight">0
                                </p>
                                <div id="risk-badge"
                                    class="flex items-center gap-1 mt-2 bg-green-500/10 w-fit px-2 py-1 rounded text-green-400">
                                    <span class="material-symbols-outlined text-[16px]">check_circle</span>
                                    <p id="risk-level" class="text-xs font-bold">Low Risk</p>
                                </div>
                            </div>
                        </div>

                        <!-- Training Metrics (Expanded) -->
                        <!-- Current VDOT Card -->
                        <div
                            class="flex flex-col gap-2 rounded-xl p-6 bg-surface-dark border border-white/5 shadow-subtle hover:border-primary/30 transition-colors group">
                            <div class="flex justify-between items-start">
                                <p
                                    class="text-text-secondary text-xs font-bold uppercase tracking-widest group-hover:text-primary transition-colors">
                                    Current VDOT</p>
                                <div class="p-2 bg-background-dark rounded-lg text-primary">
                                    <span class="material-symbols-outlined text-[20px]">speed</span>
                                </div>
                            </div>
                            <div class="mt-2">
                                <p class="text-white text-3xl font-bold leading-tight tracking-tight"><span
                                        id="current-vdot">-</span></p>
                                <p id="best-effort-info" class="text-xs text-text-secondary mt-2">Loading...</p>
                            </div>
                            <div id="training-paces" class="mt-3 space-y-1 hidden">
                                <p class="text-xs text-text-secondary font-bold uppercase mb-2">Training Paces</p>
                            </div>
                        </div>

                        <!-- Fitness Status Card -->
                        <div
                            class="flex flex-col gap-2 rounded-xl p-6 bg-surface-dark border border-white/5 shadow-subtle hover:border-primary/30 transition-colors group">
                            <div class="flex justify-between items-start">
                                <p
                                    class="text-text-secondary text-xs font-bold uppercase tracking-widest group-hover:text-primary transition-colors">
                                    Fitness Status</p>
                                <div class="p-2 bg-background-dark rounded-lg text-primary">
                                    <span class="material-symbols-outlined text-[20px]">monitor_heart</span>
                                </div>
                            </div>
                            <div class="mt-2">
                                <div id="fitness-status-badge"
                                    class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-blue-500/10 w-fit mb-3">
                                    <span id="fitness-status-text"
                                        class="text-blue-400 text-sm font-bold">Loading</span>
                                </div>
                                <div class="grid grid-cols-3 gap-2 text-center">
                                    <div class="bg-background-dark rounded-lg p-2">
                                        <p class="text-[10px] text-text-secondary font-bold">CTL</p>
                                        <p id="ctl-value" class="text-white text-sm font-bold">-</p>
                                    </div>
                                    <div class="bg-background-dark rounded-lg p-2">
                                        <p class="text-[10px] text-text-secondary font-bold">ATL</p>
                                        <p id="atl-value" class="text-white text-sm font-bold">-</p>
                                    </div>
                                    <div class="bg-background-dark rounded-lg p-2">
                                        <p class="text-[10px] text-text-secondary font-bold">TSB</p>
                                        <p id="tsb-value" class="text-white text-sm font-bold">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Training Balance Card -->
                        <div
                            class="flex flex-col gap-2 rounded-xl p-6 bg-surface-dark border border-white/5 shadow-subtle hover:border-primary/30 transition-colors group">
                            <div class="flex justify-between items-start">
                                <p
                                    class="text-text-secondary text-xs font-bold uppercase tracking-widest group-hover:text-primary transition-colors">
                                    Training Balance</p>
                                <div class="p-2 bg-background-dark rounded-lg text-primary">
                                    <span class="material-symbols-outlined text-[20px]">balance</span>
                                </div>
                            </div>
                            <div class="mt-2">
                                <div class="flex items-baseline gap-2">
                                    <p id="balance-score"
                                        class="text-white text-3xl font-bold leading-tight tracking-tight">-</p>
                                    <span class="text-lg text-text-secondary font-medium">/100</span>
                                </div>
                                <div id="balance-badge"
                                    class="flex items-center gap-1 mt-2 bg-blue-500/10 w-fit px-2 py-1 rounded text-blue-400">
                                    <span class="material-symbols-outlined text-[16px]">check_circle</span>
                                    <p id="balance-assessment" class="text-xs font-bold">-</p>
                                </div>
                                <p id="easy-hard-ratio" class="text-[10px] text-text-secondary mt-2">Easy/Hard: -</p>
                            </div>
                        </div>

                        <!-- Weather & Running Index Section -->
                        <!-- Current Running Index Card -->
                        <div
                            class="md:col-span-2 flex flex-col gap-2 rounded-xl p-6 bg-surface-dark border border-white/5 shadow-subtle hover:border-primary/30 transition-colors group">
                            <div class="flex justify-between items-start">
                                <p
                                    class="text-text-secondary text-xs font-bold uppercase tracking-widest group-hover:text-primary transition-colors">
                                    Running Index</p>
                                <div class="p-2 bg-background-dark rounded-lg text-primary">
                                    <span class="material-symbols-outlined text-[20px]">cloud</span>
                                </div>
                            </div>
                            <div class="mt-2" id="weather-card">
                                <div id="weather-loading" class="text-text-secondary text-sm">Loading weather...</div>
                                <div id="weather-content" class="hidden">
                                    <div class="flex items-baseline gap-2">
                                        <p id="running-score"
                                            class="text-white text-4xl font-bold leading-tight tracking-tight">-</p>
                                        <span class="text-lg text-text-secondary font-medium">/100</span>
                                    </div>
                                    <div id="running-rating-badge"
                                        class="flex items-center gap-1 mt-2 bg-green-500/10 w-fit px-2 py-1 rounded text-green-400">
                                        <span class="material-symbols-outlined text-[16px]">check_circle</span>
                                        <p id="running-rating" class="text-xs font-bold">-</p>
                                    </div>
                                    <p id="weather-advice" class="text-sm text-text-secondary mt-3"></p>
                                    <div class="grid grid-cols-4 gap-2 mt-4 text-center">
                                        <div class="bg-background-dark rounded-lg p-2">
                                            <p class="text-[10px] text-text-secondary font-bold">TEMP</p>
                                            <p id="weather-temp" class="text-white text-sm font-bold">-°C</p>
                                        </div>
                                        <div class="bg-background-dark rounded-lg p-2">
                                            <p class="text-[10px] text-text-secondary font-bold">HUMID</p>
                                            <p id="weather-humidity" class="text-white text-sm font-bold">-%</p>
                                        </div>
                                        <div class="bg-background-dark rounded-lg p-2">
                                            <p class="text-[10px] text-text-secondary font-bold">WIND</p>
                                            <p id="weather-wind" class="text-white text-sm font-bold">-m/s</p>
                                        </div>
                                        <div class="bg-background-dark rounded-lg p-2">
                                            <p class="text-[10px] text-text-secondary font-bold">SKY</p>
                                            <p id="weather-sky" class="text-white text-sm font-bold">-</p>
                                        </div>
                                    </div>
                                    <div id="weather-warnings" class="mt-3 space-y-1"></div>
                                </div>
                                <div id="weather-unavailable" class="hidden text-text-secondary text-sm">
                                    <p>Weather data unavailable.</p>
                                    <p class="text-xs mt-1">Set KMA_API_KEY to enable.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Hourly Forecast Card -->
                        <div
                            class="flex flex-col gap-2 rounded-xl p-6 bg-surface-dark border border-white/5 shadow-subtle hover:border-primary/30 transition-colors group">
                            <div class="flex justify-between items-start">
                                <p
                                    class="text-text-secondary text-xs font-bold uppercase tracking-widest group-hover:text-primary transition-colors">
                                    Best Time to Run</p>
                                <div class="p-2 bg-background-dark rounded-lg text-primary">
                                    <span class="material-symbols-outlined text-[20px]">schedule</span>
                                </div>
                            </div>
                            <div class="mt-2" id="hourly-card">
                                <div id="hourly-loading" class="text-text-secondary text-sm">Loading forecast...</div>
                                <div id="hourly-content" class="hidden">
                                    <p id="best-time-recommendation" class="text-white text-sm font-medium mb-4"></p>
                                    <div id="hourly-scores" class="flex gap-1 overflow-x-auto pb-2">
                                        <!-- Hourly bars will be injected here -->
                                    </div>
                                </div>
                                <div id="hourly-unavailable" class="hidden text-text-secondary text-sm">
                                    <p>Hourly forecast unavailable.</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Chart & Activities Section -->
                    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <!-- Activity Detail Chart -->
                        <div id="detail-view"
                            class="lg:col-span-2 min-h-[450px] rounded-xl bg-surface-dark border border-white/5 p-6 flex flex-col justify-between shadow-subtle"
                            style="display: none;">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h3 id="detail-title" class="text-white text-lg font-bold">Activity Details</h3>
                                    <p class="text-text-secondary text-sm">Pace & Heart Rate Analysis</p>
                                </div>
                                <button onclick="closeDetail()"
                                    class="text-text-secondary hover:text-white transition-colors">
                                    <span class="material-symbols-outlined">close</span>
                                </button>
                            </div>

                            <!-- Stats Grid -->
                            <div class="grid grid-cols-4 gap-4 mb-6">
                                <div class="bg-background-dark rounded-lg p-4 text-center">
                                    <p class="text-text-secondary text-xs font-bold uppercase tracking-wider mb-1">
                                        Distance</p>
                                    <p class="text-white text-xl font-bold"><span id="detail-dist">0.0</span><span
                                            class="text-sm text-text-secondary ml-1">km</span></p>
                                </div>
                                <div class="bg-background-dark rounded-lg p-4 text-center">
                                    <p class="text-text-secondary text-xs font-bold uppercase tracking-wider mb-1">Time
                                    </p>
                                    <p id="detail-time" class="text-white text-xl font-bold">00:00</p>
                                </div>
                                <div class="bg-background-dark rounded-lg p-4 text-center">
                                    <p class="text-text-secondary text-xs font-bold uppercase tracking-wider mb-1">Avg
                                        Pace</p>
                                    <p class="text-primary text-xl font-bold"><span id="detail-pace">0:00</span><span
                                            class="text-sm text-text-secondary ml-1">/km</span></p>
                                </div>
                                <div class="bg-background-dark rounded-lg p-4 text-center">
                                    <p class="text-text-secondary text-xs font-bold uppercase tracking-wider mb-1">Avg
                                        HR</p>
                                    <p class="text-white text-xl font-bold"><span id="detail-hr">-</span><span
                                            class="text-sm text-text-secondary ml-1">bpm</span></p>
                                </div>
                            </div>

                            <div class="flex-1 min-h-[200px]">
                                <canvas id="activityChart"></canvas>
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div id="empty-view"
                            class="lg:col-span-2 min-h-[450px] rounded-xl bg-surface-dark border border-white/5 p-6 flex flex-col items-center justify-center shadow-subtle text-center">
                            <div
                                class="w-16 h-16 rounded-full bg-surface-highlight flex items-center justify-center mb-4">
                                <span class="material-symbols-outlined text-primary text-3xl">touch_app</span>
                            </div>
                            <h3 class="text-white text-lg font-bold mb-2">Select an activity</h3>
                            <p class="text-text-secondary text-sm max-w-sm">Choose a run from the list to view detailed
                                analytics and charts.</p>
                        </div>

                        <!-- Recent Activities -->
                        <div
                            class="lg:col-span-1 h-full rounded-xl bg-surface-dark border border-white/5 p-6 flex flex-col gap-5 shadow-subtle">
                            <div class="flex justify-between items-center">
                                <h3 class="text-white text-lg font-bold">Recent Runs</h3>
                                <a href="/activities"
                                    class="text-primary text-xs font-bold uppercase tracking-wider hover:text-white transition-colors">View
                                    All</a>
                            </div>
                            <div class="flex flex-col gap-2 overflow-y-auto max-h-[400px] pr-2">
                                <th:block th:if="${not #lists.isEmpty(recentActivities)}">
                                    <div th:each="act : ${recentActivities}"
                                        th:onclick="'loadActivity(' + ${act.activityId} + ', this)'"
                                        class="activity-item group flex items-center justify-between p-3 rounded-lg bg-surface-highlight/30 hover:bg-surface-highlight cursor-pointer transition-colors border border-transparent hover:border-white/5">
                                        <div class="flex items-center gap-3">
                                            <div
                                                class="size-10 rounded-lg bg-blue-500/10 flex items-center justify-center text-blue-400 group-hover:bg-blue-500 group-hover:text-white transition-colors">
                                                <span
                                                    class="material-symbols-outlined text-[20px]">directions_run</span>
                                            </div>
                                            <div>
                                                <p class="text-white text-sm font-semibold group-hover:text-primary transition-colors"
                                                    th:text="${#numbers.formatDecimal(act.distanceM / 1000.0, 1, 2) + ' km Run'}">
                                                    5.0 km Run</p>
                                                <p class="text-text-secondary text-xs" th:text="${act.date}">2023-10-25
                                                </p>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-primary text-sm font-bold"
                                                th:if="${act.avgPaceSecPerKm != null}"
                                                th:text="${act.avgPaceSecPerKm / 60} + ':' + ${#numbers.formatInteger(act.avgPaceSecPerKm % 60, 2)} + '/km'">
                                                5:30/km</p>
                                            <div th:if="${act.avgHr != null}"
                                                class="flex items-center justify-end gap-1 text-text-secondary text-xs">
                                                <span class="material-symbols-outlined text-[14px]">favorite</span>
                                                <span th:text="${act.avgHr}">150</span> bpm
                                            </div>
                                        </div>
                                    </div>
                                </th:block>
                                <div th:if="${#lists.isEmpty(recentActivities)}" class="text-center py-8">
                                    <span
                                        class="material-symbols-outlined text-text-secondary text-4xl mb-2">directions_run</span>
                                    <p class="text-text-secondary text-sm">No recent activities found.</p>
                                    <p class="text-text-secondary text-xs mt-1">Connect Strava to sync your runs.</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Bottom Section: API Tokens & Anomalies -->
                    <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Anomalies Count -->
                        <div
                            class="bg-surface-dark rounded-xl p-5 border border-white/5 shadow-subtle flex flex-col items-center justify-between relative overflow-hidden">
                            <div
                                class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-primary to-transparent opacity-50">
                            </div>
                            <h4
                                class="text-text-secondary text-xs font-bold uppercase tracking-wider w-full text-center mb-4">
                                Anomalies (30d)</h4>
                            <div class="size-20 rounded-full bg-surface-highlight flex items-center justify-center">
                                <span id="anomaly-count" class="text-white text-3xl font-bold">0</span>
                            </div>
                            <p class="text-xs text-text-secondary mt-4">Detected fatigue signs</p>
                        </div>

                        <!-- API Tokens -->
                        <div class="bg-surface-dark rounded-xl p-5 border border-white/5 shadow-subtle">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-text-secondary text-xs font-bold uppercase tracking-wider">API Tokens
                                </h4>
                                <button onclick="createToken()"
                                    class="flex items-center gap-1 text-primary hover:text-white transition-colors text-xs font-bold">
                                    <span class="material-symbols-outlined text-[16px]">add</span> New Token
                                </button>
                            </div>
                            <div class="space-y-2 max-h-[120px] overflow-y-auto">
                                <th:block th:if="${not #lists.isEmpty(tokens)}">
                                    <div th:each="token : ${tokens}"
                                        class="flex items-center justify-between p-3 bg-background-dark rounded-lg">
                                        <div>
                                            <p class="text-white text-sm font-medium" th:text="${token.name}">MacBook
                                            </p>
                                            <code
                                                class="text-xs text-text-secondary font-mono blur-sm hover:blur-none transition-all cursor-pointer"
                                                th:text="${token.token}">sk-...</code>
                                        </div>
                                        <button th:onclick="'deleteToken(' + ${token.id} + ')'"
                                            class="text-red-400 hover:text-red-300 transition-colors">
                                            <span class="material-symbols-outlined text-[18px]">delete</span>
                                        </button>
                                    </div>
                                </th:block>
                                <div th:if="${#lists.isEmpty(tokens)}" class="text-center py-4">
                                    <p class="text-text-secondary text-xs">No tokens generated.</p>
                                </div>
                            </div>
                        </div>

                        <!-- MCP Info -->
                        <div
                            class="bg-surface-dark rounded-xl p-5 border border-white/5 shadow-subtle flex flex-col justify-between relative overflow-hidden group">
                            <div
                                class="absolute -right-6 -top-6 bg-primary/10 size-24 rounded-full group-hover:scale-150 transition-transform duration-700">
                            </div>
                            <div class="flex justify-between items-center mb-2 z-10">
                                <h4 class="text-text-secondary text-xs font-bold uppercase tracking-wider">MCP Server
                                </h4>
                                <span class="material-symbols-outlined text-primary text-sm">smart_toy</span>
                            </div>
                            <div class="z-10">
                                <p class="text-white text-sm font-bold mb-1">SSE Endpoint</p>
                                <code
                                    class="text-xs text-primary bg-background-dark px-2 py-1 rounded block truncate">/sse</code>
                            </div>
                            <a href="https://github.com/hansu/running-pacer#mcp-서버-사용법" target="_blank"
                                class="mt-3 text-xs text-text-secondary hover:text-primary transition-colors z-10 flex items-center gap-1">
                                Learn more <span class="material-symbols-outlined text-[14px]">open_in_new</span>
                            </a>
                        </div>
                    </section>
                </div>
            </main>
        </div>
    </div>

    <!-- Sync Modal -->
    <div id="syncModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-surface-dark rounded-2xl p-6 w-full max-w-md border border-white/10 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-white text-lg font-bold">Custom Sync</h3>
                <button onclick="closeSyncModal()" class="text-text-secondary hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <p class="text-text-secondary text-sm mb-6">Select date range to sync from Strava.</p>
            <form id="syncForm" onsubmit="handleCustomSync(event)" class="space-y-4">
                <div>
                    <label class="text-white text-sm font-medium block mb-2">From Date</label>
                    <input type="date" name="from" required
                        class="w-full h-10 px-3 bg-background-dark border border-border-dark rounded-lg text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none">
                </div>
                <div>
                    <label class="text-white text-sm font-medium block mb-2">To Date</label>
                    <input type="date" name="to" required
                        class="w-full h-10 px-3 bg-background-dark border border-border-dark rounded-lg text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none">
                </div>
                <button type="submit"
                    class="w-full h-10 bg-primary hover:bg-primary-hover text-background-dark font-bold rounded-lg transition-colors shadow-glow">
                    Start Sync
                </button>
            </form>
        </div>
    </div>

    <script>
        let myChart = null;

        function openSyncModal() {
            const modal = document.getElementById('syncModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            const today = new Date().toISOString().split('T')[0];
            const lastMonth = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            document.querySelector('input[name="to"]').value = today;
            document.querySelector('input[name="from"]').value = lastMonth;
        }

        function closeSyncModal() {
            const modal = document.getElementById('syncModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        async function handleCustomSync(e) {
            e.preventDefault();
            const form = e.target;
            const from = form.from.value;
            const to = form.to.value;
            try {
                const res = await fetch(`/admin/sync/activities?from=${from}&to=${to}`, { method: 'POST' });
                const data = await res.json();
                alert(data.message);
                closeSyncModal();
                window.location.reload();
            } catch (err) {
                alert('Sync failed: ' + err.message);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadDashboard();
        });

        async function loadDashboard() {
            try {
                const res = await fetch('/api/dashboard/insights');
                if (!res.ok) return;
                const data = await res.json();
                renderDashboard(data);
                loadWeather();
            } catch (e) { console.error('Failed to load dashboard', e); }
        }

        function renderDashboard(data) {
            document.getElementById('week-dist').innerText = (data.weeklySummary.totalDistanceM / 1000.0).toFixed(1);
            document.getElementById('week-count').innerText = `${data.weeklySummary.runCount} runs this week`;

            const trendVal = data.trend.changePercent ? (data.trend.changePercent > 0 ? '+' : '') + data.trend.changePercent.toFixed(1) + '%' : '-';
            document.getElementById('trend-val').innerText = trendVal;
            document.getElementById('trend-desc').innerText = data.trend.interpretation;

            document.getElementById('anomaly-count').innerText = data.anomaliesCount;

            const riskEl = document.getElementById('risk-score');
            riskEl.innerText = data.riskScore;

            const riskBadge = document.getElementById('risk-badge');
            const riskLevel = document.getElementById('risk-level');
            riskLevel.innerText = `${data.riskLevel} Risk`;

            if (data.riskLevel === 'HIGH') {
                riskBadge.className = 'flex items-center gap-1 mt-2 bg-red-500/10 w-fit px-2 py-1 rounded text-red-400';
            } else if (data.riskLevel === 'MEDIUM') {
                riskBadge.className = 'flex items-center gap-1 mt-2 bg-yellow-500/10 w-fit px-2 py-1 rounded text-yellow-400';
            }

            if (data.trend.dataPoints && data.trend.dataPoints.length > 0) {
                renderSparkline('trendChart', data.trend.dataPoints.map(p => p.value), '#FFB300');
            }

            // Render new training metrics
            renderTrainingMetrics(data);
        }

        function renderTrainingMetrics(data) {
            // VDOT Card
            if (data.currentVdot) {
                document.getElementById('current-vdot').innerText = data.currentVdot.toFixed(1);

                if (data.bestEfforts && data.bestEfforts.length > 0) {
                    const best = data.bestEfforts[0];
                    document.getElementById('best-effort-info').innerText = `Based on ${best.distanceType} (${formatTime(best.timeSeconds)})`;
                } else {
                    document.getElementById('best-effort-info').innerText = 'Estimated from recent runs';
                }

                // Training paces
                if (data.trainingPaces) {
                    const pacesEl = document.getElementById('training-paces');
                    pacesEl.classList.remove('hidden');
                    const paceOrder = ['EASY', 'MARATHON', 'THRESHOLD', 'INTERVAL', 'REPETITION'];
                    paceOrder.forEach(type => {
                        if (data.trainingPaces[type]) {
                            const paceDiv = document.createElement('div');
                            paceDiv.className = 'flex justify-between text-xs';
                            paceDiv.innerHTML = `<span class="text-text-secondary">${type}</span><span class="text-primary font-bold">${data.trainingPaces[type]}</span>`;
                            pacesEl.appendChild(paceDiv);
                        }
                    });
                }
            } else {
                document.getElementById('best-effort-info').innerText = 'No data yet';
            }

            // Fitness Status Card
            if (data.fitnessStatus) {
                const fs = data.fitnessStatus;
                document.getElementById('ctl-value').innerText = fs.ctl.toFixed(1);
                document.getElementById('atl-value').innerText = fs.atl.toFixed(1);
                document.getElementById('tsb-value').innerText = fs.tsb.toFixed(1);

                const statusText = document.getElementById('fitness-status-text');
                const statusBadge = document.getElementById('fitness-status-badge');
                statusText.innerText = fs.status;

                const statusColors = {
                    'Rested': 'bg-cyan-500/10 text-cyan-400',
                    'Fresh': 'bg-green-500/10 text-green-400',
                    'Productive': 'bg-blue-500/10 text-blue-400',
                    'Tired': 'bg-yellow-500/10 text-yellow-400',
                    'Overreached': 'bg-red-500/10 text-red-400'
                };
                const colorClass = statusColors[fs.status] || 'bg-blue-500/10 text-blue-400';
                statusBadge.className = `flex items-center gap-2 px-3 py-1.5 rounded-full ${colorClass} w-fit mb-3`;
            } else {
                document.getElementById('fitness-status-text').innerText = 'No data';
            }

            // Training Balance Card
            if (data.workoutDistribution) {
                const wd = data.workoutDistribution;
                document.getElementById('balance-score').innerText = wd.balanceScore;
                document.getElementById('balance-assessment').innerText = wd.balanceAssessment;
                document.getElementById('easy-hard-ratio').innerText = `Easy/Hard: ${wd.easyHardRatio}`;

                const balanceBadge = document.getElementById('balance-badge');
                if (wd.balanceScore >= 75) {
                    balanceBadge.className = 'flex items-center gap-1 mt-2 bg-green-500/10 w-fit px-2 py-1 rounded text-green-400';
                } else if (wd.balanceScore >= 50) {
                    balanceBadge.className = 'flex items-center gap-1 mt-2 bg-yellow-500/10 w-fit px-2 py-1 rounded text-yellow-400';
                } else {
                    balanceBadge.className = 'flex items-center gap-1 mt-2 bg-red-500/10 w-fit px-2 py-1 rounded text-red-400';
                }
            }
        }

        async function loadWeather() {
            try {
                const res = await fetch('/api/dashboard/weather');
                if (!res.ok) {
                    showWeatherUnavailable();
                    return;
                }
                const data = await res.json();
                renderWeather(data);
            } catch (e) {
                console.error('Failed to load weather', e);
                showWeatherUnavailable();
            }
        }

        function showWeatherUnavailable() {
            document.getElementById('weather-loading').classList.add('hidden');
            document.getElementById('weather-unavailable').classList.remove('hidden');
            document.getElementById('hourly-loading').classList.add('hidden');
            document.getElementById('hourly-unavailable').classList.remove('hidden');
        }

        function renderWeather(data) {
            // Current weather
            if (data.current) {
                const c = data.current;
                document.getElementById('weather-loading').classList.add('hidden');
                document.getElementById('weather-content').classList.remove('hidden');

                document.getElementById('running-score').innerText = c.score;
                document.getElementById('running-rating').innerText = c.rating;
                document.getElementById('weather-advice').innerText = c.advice;

                const w = c.weather;
                document.getElementById('weather-temp').innerText = w.temp != null ? w.temp + '°C' : '-';
                document.getElementById('weather-humidity').innerText = w.humidity != null ? w.humidity + '%' : '-';
                document.getElementById('weather-wind').innerText = w.windSpeed != null ? w.windSpeed.toFixed(1) + 'm/s' : '-';

                const skyKorean = { 'CLEAR': '맑음', 'PARTLY_CLOUDY': '구름조금', 'CLOUDY': '흐림' };
                document.getElementById('weather-sky').innerText = skyKorean[w.sky] || w.sky;

                // Rating badge colors
                const ratingBadge = document.getElementById('running-rating-badge');
                const ratingColors = {
                    'EXCELLENT': 'bg-green-500/10 text-green-400',
                    'GOOD': 'bg-blue-500/10 text-blue-400',
                    'FAIR': 'bg-yellow-500/10 text-yellow-400',
                    'POOR': 'bg-orange-500/10 text-orange-400',
                    'BAD': 'bg-red-500/10 text-red-400'
                };
                ratingBadge.className = `flex items-center gap-1 mt-2 w-fit px-2 py-1 rounded ${ratingColors[c.rating] || ratingColors['FAIR']}`;

                // Warnings
                const warningsEl = document.getElementById('weather-warnings');
                warningsEl.innerHTML = '';
                if (c.warnings && c.warnings.length > 0) {
                    c.warnings.forEach(w => {
                        const div = document.createElement('div');
                        div.className = 'text-xs text-yellow-400 bg-yellow-500/10 px-2 py-1 rounded';
                        div.innerText = w;
                        warningsEl.appendChild(div);
                    });
                }
            } else {
                document.getElementById('weather-loading').classList.add('hidden');
                document.getElementById('weather-unavailable').classList.remove('hidden');
            }

            // Hourly forecast
            if (data.hourly && data.hourly.hourlyScores && data.hourly.hourlyScores.length > 0) {
                document.getElementById('hourly-loading').classList.add('hidden');
                document.getElementById('hourly-content').classList.remove('hidden');

                document.getElementById('best-time-recommendation').innerText = data.hourly.recommendation;

                const container = document.getElementById('hourly-scores');
                container.innerHTML = '';

                data.hourly.hourlyScores.forEach(h => {
                    const bar = document.createElement('div');
                    bar.className = 'flex flex-col items-center min-w-[40px]';

                    const scoreColor = h.score >= 80 ? 'bg-green-500' : h.score >= 60 ? 'bg-blue-500' : h.score >= 40 ? 'bg-yellow-500' : 'bg-red-500';
                    const barHeight = Math.max(20, h.score * 0.6);

                    bar.innerHTML = `
                        <div class="text-[10px] text-text-secondary mb-1">${h.score}</div>
                        <div class="${scoreColor} w-6 rounded-t" style="height: ${barHeight}px"></div>
                        <div class="text-[10px] text-text-secondary mt-1">${h.hour}시</div>
                    `;
                    container.appendChild(bar);
                });
            } else {
                document.getElementById('hourly-loading').classList.add('hidden');
                document.getElementById('hourly-unavailable').classList.remove('hidden');
            }
        }

        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function renderSparkline(canvasId, data, color) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map((_, i) => i),
                    datasets: [{
                        data: data,
                        borderColor: color,
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.4,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: { x: { display: false }, y: { display: false } }
                }
            });
        }

        function closeDetail() {
            document.getElementById('empty-view').style.display = 'flex';
            document.getElementById('detail-view').style.display = 'none';
            document.querySelectorAll('.activity-item').forEach(el => el.classList.remove('border-primary'));
        }

        async function loadActivity(id, element) {
            document.querySelectorAll('.activity-item').forEach(el => el.classList.remove('border-primary'));
            if (element) element.classList.add('border-primary');

            document.getElementById('empty-view').style.display = 'none';
            document.getElementById('detail-view').style.display = 'flex';

            try {
                const detailRes = await fetch(`/api/activities/${id}`);
                const detail = await detailRes.json();
                renderDetail(detail);

                const streamsRes = await fetch(`/api/activities/${id}/streams`);
                if (streamsRes.ok) {
                    const streams = await streamsRes.json();
                    renderChart(streams);
                } else {
                    if (myChart) myChart.destroy();
                }
            } catch (e) {
                console.error(e);
                alert('Failed to load activity details');
            }
        }

        function renderDetail(d) {
            document.getElementById('detail-title').innerText = `${d.date} • ${d.startTime}`;
            document.getElementById('detail-dist').innerText = (d.distanceM / 1000.0).toFixed(2);

            const min = Math.floor(d.movingTimeS / 60);
            const sec = d.movingTimeS % 60;
            document.getElementById('detail-time').innerText = `${min}:${sec.toString().padStart(2, '0')}`;

            if (d.avgPaceSecPerKm) {
                const pMin = Math.floor(d.avgPaceSecPerKm / 60);
                const pSec = d.avgPaceSecPerKm % 60;
                document.getElementById('detail-pace').innerText = `${pMin}:${pSec.toString().padStart(2, '0')}`;
            } else {
                document.getElementById('detail-pace').innerText = "-";
            }

            document.getElementById('detail-hr').innerText = d.avgHr || "-";
        }

        function renderChart(streams) {
            const ctx = document.getElementById('activityChart').getContext('2d');
            if (myChart) myChart.destroy();

            const distData = streams.distance?.data || [];
            const hrData = streams.heartrate?.data || [];
            const paceData = (streams.velocity_smooth?.data || []).map(v => v > 0 ? (1000 / v) / 60 : null);
            const labels = distData.map(d => (d / 1000).toFixed(1));

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Heart Rate (bpm)',
                            data: hrData,
                            borderColor: '#e91e63',
                            backgroundColor: 'rgba(233, 30, 99, 0.1)',
                            yAxisID: 'y',
                            tension: 0.4,
                            pointRadius: 0
                        },
                        {
                            label: 'Pace (min/km)',
                            data: paceData,
                            borderColor: '#FFB300',
                            backgroundColor: 'rgba(255, 179, 0, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.4,
                            pointRadius: 0,
                            spanGaps: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: '#94a3b8' }
                        }
                    },
                    scales: {
                        x: { display: false },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'BPM', color: '#94a3b8' },
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            reverse: true,
                            title: { display: true, text: 'Pace', color: '#94a3b8' },
                            ticks: { color: '#94a3b8' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        async function connectStrava() {
            try {
                const response = await fetch('/oauth/strava/authorize');
                const data = await response.json();
                if (data.url) window.location.href = data.url;
            } catch (e) { alert('Error connecting to Strava'); }
        }

        async function createToken() {
            const name = prompt("Token Name:");
            if (!name) return;
            await fetch('/api/tokens', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name }) });
            window.location.reload();
        }

        async function deleteToken(id) {
            if (!confirm('Revoke token?')) return;
            await fetch('/api/tokens/' + id, { method: 'DELETE' });
            window.location.reload();
        }
    </script>
</body>

</html>